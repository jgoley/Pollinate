function disposeViews(){Bees.currentView&&Bees.currentView.dispose()}function calculateCost(e,s){var t=0,i=0,n=0;i=Parse.User.current().get("geoCenter").milesTo(s.get("geoCenter")),i>s.get("maxDistFree")&&(n=Math.floor(i-s.get("maxDistFree")),t=roundToTwo(n*(s.get("costPerMile")/100)));var r=roundToTwo(t+e*s.get("costPerHive")),a={totalCost:+r.toFixed(2),milesOver:+n,mileageCost:+t.toFixed(2),numHives:+e};return a}function removeNotification(e){$(e).remove()}function firstCap(e){return e.charAt(0).toUpperCase()+e.slice(1)}function roundToTwo(e){return+(Math.round(e+"e+2")+"e-2")}function sendMail(e){Parse.Cloud.run("sendEmail",e,{success:function(e){console.log(e)},error:function(e){console.log(e)}})}function queryBeekeepers(e){return Parse.Cloud.run("queryBeekeepers",{distance:e},{success:function(e){return e},error:function(e){console.log(e)}})}function saveLocation(){return Parse.Cloud.run("saveLocation",{},{success:function(e){return Parse.User.current().fetch(),e},error:function(e){console.log(e)}})}var BaseView=function(e){this.bindings=[],Parse.View.apply(this,[e]),Bees.viewIndex[this.cid]=this};_.extend(BaseView.prototype,Parse.View.prototype,{listenTo:function(e,s,t){e.bind(s,t,this),this.bindings.push({model:e,ev:s,callback:t})},stopListeningAll:function(){_.each(this.bindings,function(e){e.model.unbind(e.ev,e.callback)}),this.bindings=[]},dispose:function(){this.stopListeningAll(),this.unbind(),this.remove(),_.invoke(this.subViews,"dispose"),delete Bees.viewIndex[this.cid]}}),BaseView.extend=Parse.View.extend,Parse.Collection.prototype.where=function(e,s){return _.isEmpty(e)?s?void 0:[]:this[s?"find":"filter"](function(s){for(var t in e)if(e[t]!==s.get(t))return!1;return!0})},Parse.Collection.prototype.findWhere=function(e){return this.where(e,!0)},$.fn.serializeObject=function(){return this.serializeArray().reduce(function(e,s){return e[s.name]=s.value,e},{})},Handlebars.registerHelper("if_eq",function(e,s,t){return e===s?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("log",function(e){return console.log(e)}),function(){"use strict";window.Bees=window.Bees||{},Bees.Views={},Bees.Models={},Bees.Collections={},Bees.currentView=null,Bees.viewIndex={}}(),$(function(){Parse.initialize("HJ2pcl7OeW4shsUtxq04ZzZAQeAgwSIhe5IaWiQt","UxWDTnnEnZc20pFLzbPP3IikP8RZlOa7VwRAB7Xz"),window.BeesApp=new Bees.Router,Parse.history.start(),$.slidebars()}),function(){"use strict";Bees.Models.Session=Parse.Object.extend({className:"Session",defaults:{user:null,timestamp:new Date}}),Bees.Models.User=Parse.User.extend({className:"User",defaults:{businessName:"",username:"",firstName:"",lastName:"",address:"",city:"",state:"",image:""}}),Bees.Models.Profile=Parse.Object.extend({className:"Profile",defaults:{images:"",text:""}}),Bees.Models.Bid=Parse.Object.extend({className:"Bids",defaults:{beekeeper:"",farmer:"",hiveGroup:"",bidAmount:0,accepted:!1}}),Bees.Models.HiveGroup=Parse.Object.extend({className:"Hive_Group",defaults:{beekeeper:"",hiveCount:"",availableBegin:"",availableEnd:"",bid:""}}),Bees.Models.Review=Parse.Object.extend({className:"Reviews",defaults:{review:""}}),Bees.Models.Request=Parse.Object.extend({className:"Requests",defaults:{accepted:!1}}),Bees.Models.Message=Parse.Object.extend({className:"Messages",defaults:{replied:!1}})}(),function(){"use strict";Bees.Collections.HiveGroups=Parse.Collection.extend({model:Bees.Models.HiveGroup}),Bees.Collections.User=Parse.Collection.extend({model:Bees.Models.User}),Bees.Collections.UserSearchGeo=Parse.Collection.extend({initialize:function(e){var s=_.defaults({},e,{distance:e.distance,userType:e.userType,limit:e.limit});this.query=new Parse.Query("User").equalTo("userType",s.userType).withinMiles("geoCenter",Parse.User.current().get("geoCenter"),s.distance).limit(s.limit)},model:Bees.Models.User}),Bees.Collections.UserSearch=Parse.Collection.extend({initialize:function(e){var s=_.defaults({},e,{userId:e.userId});this.query=new Parse.Query("User").equalTo("objectId",s.userId)},model:Bees.Models.User}),Bees.Collections.NameSearch=Parse.Collection.extend({initialize:function(e){var s=_.defaults({},e,{userType:e.userType,business:e.business});this.query=new Parse.Query("User").equalTo("userType",s.userType).contains("businessNameLowercase",s.business)},model:Bees.Models.User}),Bees.Collections.UserReviews=Parse.Collection.extend({initialize:function(e){var s=_.defaults({},e,{user:e.user,limit:e.limit,skip:e.skip});this.user=s.user,this.query=new Parse.Query("Reviews").equalTo("reviewee",s.user).ascending("createdAt").limit(s.limit).skip(s.skip)},model:Bees.Models.Review,getAll:function(){var e=this.user.relation("reviews");return e.query().equalTo("reviewee",this.user).ascending("createdAt").limit(this.limit).skip(this.skip).find()},count:function(){return new Parse.Query("Reviews").equalTo("reviewee",this.user).count(function(e){return e})}}),Bees.Collections.Requests=Parse.Collection.extend({comparator:function(e){return e.get("startDate")},initialize:function(e){var s=_.defaults({},e,{user:e.user});this.user=s.user},model:Bees.Models.Request,getAll:function(){var e=this.user.relation("requests");return e.query().find()},getArchived:function(){var e;if("beekeeper"===this.user.get("userType"))var e="archivedBeekeeper";else e="archivedFarmer";var s=this.user.relation("requests");return s.query().equalTo(this.user.get("userType"),this.user).equalTo(e,!0).find()}}),Bees.Collections.HivesOut=Parse.Collection.extend({initialize:function(e){var s=_.defaults({},e,{user:e.user});this.user=s.user},getAll:function(){var e=this.user.relation("requests");return e.query().equalTo(this.user.get("userType"),this.user).equalTo("accepted",!0).greaterThanOrEqualTo("endDate",moment().format("YYYY-MM-DD")).lessThanOrEqualTo("startDate",moment().format("YYYY-MM-DD")).find()},model:Bees.Models.Request}),Bees.Collections.UserMessages=Parse.Collection.extend({initialize:function(e){var s=_.defaults({},e,{user:e.user});this.user=s.user;var t=new Parse.Query("Messages").equalTo("sender",s.user),i=new Parse.Query("Messages").equalTo("recipient",s.user);this.query=new Parse.Query.or(t,i).descending("createdAt")},getReceived:function(){var e=this.user.relation("messages");return e.query().equalTo("recipient",this.user).descending("createdAt").find()},getSent:function(){var e=this.user.relation("messages");return e.query().equalTo("sender",this.user).descending("createdAt").find()},model:Bees.Models.Request}),Bees.Collections.UserMessagesSent=Parse.Collection.extend({comparator:function(e){return e.get("createdAt")},initialize:function(e){var s=_.defaults({},e,{user:e.user});this.query=new Parse.Query("Messages").equalTo("sender",s.user)},model:Bees.Models.Request}),Bees.Collections.UserMessagesRecieved=Parse.Collection.extend({comparator:function(e){return e.get("createdAt")},initialize:function(e){var s=_.defaults({},e,{user:e.user});this.query=new Parse.Query("Messages").equalTo("recipient",s.user)},model:Bees.Models.Request})}(),function(){"use strict";Bees.Router=Parse.Router.extend({routes:{"":"index",login:"login",logout:"logout",newuser:"newUser",account:"account","change-password":"changePassword","user/:user_id":"user","user/:user_id/reviews":"reviews",requests:"requests","requests/archived":"requestsArchived","request/:request_id":"request","request/:request_id/edit":"editRequest",reviews:"reviews",messages:"messages","messages/message_id":"messageView",search:"search","search/:query_text":"search"},initialize:function(){Parse.User.current()&&(Parse.User.current().fetch(),this.currentUser=Parse.User.current(),this.userType=this.currentUser.get("userType")),new Bees.Views.ApplicationView({el:"body"})},index:function(){disposeViews(),Parse.User.current()?new Bees.Collections.Requests({user:Parse.User.current()}).getAll().then("beekeeper"===Parse.User.current().get("userType")?function(e){Bees.currentView=new Bees.Views.BeekeeperIndex({$container:$(".main-container"),collection:e})}:function(e){Bees.currentView=new Bees.Views.FarmerIndex({$container:$(".main-container"),collection:e})}):this.goLogin()},login:function(){disposeViews(),Bees.currentView=new Bees.Views.LoginView({$container:$(".main-container"),session:new Bees.Models.Session})},logout:function(){disposeViews(),Parse.User.logOut(),Bees.Session.set("user",null),BeesApp.navigate("login",{trigger:!0})},newUser:function(){disposeViews(),Bees.currentView=new Bees.Views.NewUserView({$container:$(".main-container")})},account:function(){disposeViews(),Parse.User.current()?Bees.currentView=new Bees.Views.EditAccountView({$container:$(".main-container"),model:Parse.User.current()}):this.goLogin()},changePassword:function(){disposeViews()},user:function(e){if(disposeViews(),Parse.User.current()){var s=new Parse.Query(Bees.Models.User);s.get(e).then(function(e){Bees.currentView=new Bees.Views.User({model:e,$container:$(".main-container")})})}else this.goLogin()},requests:function(){disposeViews(),Parse.User.current()?new Bees.Collections.Requests({user:Parse.User.current()}).getAll().then(function(e){Bees.currentView=new Bees.Views.Requests({$container:$(".main-container"),collection:e})}).fail(function(e){console.error(e)}):this.goLogin()},requestsArchived:function(){disposeViews(),Parse.User.current()?new Bees.Collections.Requests({user:Parse.User.current()}).getArchived().then(function(e){Bees.currentView=new Bees.Views.Requests({$container:$(".main-container"),collection:e})}):this.goLogin()},request:function(e){if(disposeViews(),Parse.User.current()){var s=new Parse.Query("Requests");s.get(e).then(function(e){Bees.currentView=new Bees.Views.Request({$container:$(".main-container"),model:e})})}else this.goLogin()},editRequest:function(e){if(disposeViews(),Parse.User.current()){var s=new Parse.Query("Requests");s.get(e).then(function(e){Bees.currentView=new Bees.Views.RequestEdit({$container:$(".main-container"),model:e})})}else this.goLogin()},reviews:function(){disposeViews(),Parse.User.current()?new Bees.Collections.UserReviews({user:Parse.User.current()}).getAll().then(function(e){Bees.currentView=new Bees.Views.UserReviewsPage({$container:$(".main-container"),collection:new Parse.Collection(e)})}):this.goLogin()},messages:function(){disposeViews(),Parse.User.current()?Bees.currentView=new Bees.Views.Messages({$container:$(".main-container")}):this.goLogin()},search:function(e){disposeViews(),Bees.currentView=new Bees.Views.Search({queryText:e,$container:$(".main-container")})},checkUserType:function(){return"beekeeper"===this.userType?!0:!1},goLogin:function(){this.navigate("/login",{trigger:!0})}})}(),function(){"use strict";Bees.Views.ApplicationView=BaseView.extend({className:"pollinate",template:Bees.templates.application,initialize:function(){Bees.Session=new Bees.Models.Session({user:Parse.User.current()}),this.model=Bees.Session,this.render(),this.listenTo(Bees.Session,"change",this.render)},render:function(){if(Parse.User.current())var e=Parse.User.current().toJSON();this.$el.html(this.template({user:e})),new Bees.Views.HeaderView({$container:$("header")}),new Bees.Views.FooterView({$container:$("footer")})}})}(),function(){"use script";Bees.Views.HeaderView=BaseView.extend({subViews:[],className:"nav-container",template:Bees.templates.header,events:{"keyup .search":"search","click .logo":"removeSelected"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render(),this.listenTo(Bees.Session,"change",this.render)},render:function(){if(Parse.User.current())var e=Parse.User.current().toJSON();this.$el.html(this.template({session:Bees.Session.toJSON(),user:e})),this.subViews.push(new Bees.Views.NavView({$container:$(".main-menu"),model:Bees.Session,user:e,viewport:"desktop"})),this.subViews.push(new Bees.Views.NavView({$container:$(".off-canvas"),model:Bees.Session,user:e,viewport:"mobile"}))},search:function(e){13===e.keyCode&&BeesApp.navigate("search/"+$(e.target).val(),{trigger:!0})},removeSelected:function(){$(".main-menu a").removeClass("selected-nav")}}),Bees.Views.NavView=BaseView.extend({tagName:"ul",template:Bees.templates.nav,events:{"click .nav-link":"addClass","click .log-out":"logout","click .log-in":"login","mouseover .account":"showSubMenu","mouseout .account":"hideSubMenu"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container,user:e.user,viewport:e.viewport});this.user=s.user,s.$container.html(this.el),this.viewport=s.viewport,this.render()},render:function(){this.$el.html(this.template({session:this.model.toJSON(),user:this.user,viewport:this.viewport}))},login:function(e){e.preventDefault(),BeesApp.navigate("login",{trigger:!0})},logout:function(e){e.preventDefault(),Parse.User.logOut(),Bees.Session.set("user",null),BeesApp.navigate("login",{trigger:!0})},showAccount:function(e){e.preventDefault(),BeesApp.navigate("/account",{trigger:!0})},addClass:function(e){$(".nav-link").removeClass("selected-nav"),$(e.target).addClass("selected-nav")},showSubMenu:function(e){$(".admin-menu").toggleClass("hidden"),$(e.target).addClass("selectedNav")},hideSubMenu:function(e){$(".admin-menu").toggleClass("hidden"),$(e.target).removeClass("selectedNav")}})}(),function(){"use strict";Bees.Views.FooterView=BaseView.extend({className:"footer-container",template:Bees.templates.footer,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.render()},render:function(){this.$el.html(this.template())}})}(),function(){"use strict";Bees.Views.LoginView=BaseView.extend({tagName:"form",className:"user-login",template:Bees.templates.login,events:{submit:"loginUser"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container,session:e.session});s.$container.html(this.el),this.render()},render:function(){this.$el.prepend(this.template()),this.$el.parsley()},loginUser:function(e){e.preventDefault();var s=this.$el.serializeObject();Parse.User.logIn(s.userName,s.pass,{success:function(e){Bees.Session.set("user",e),BeesApp.navigate("/",{trigger:!0})},error:function(e,s){alert(s.message)}})}})}(),function(){"use script";Bees.Views.NewUserView=BaseView.extend({tagName:"form",className:"new-user",template:Bees.templates.newUser.index,subViews:[],user:{email:"jgoley@gmail.com",firstName:"Jonathan",lastName:"Goley",address:"2433 Lower Richland Blvd.",city:"hopkins",state:"SC",zipCode:"29061",password:"pass"},events:{submit:"createUser","change .userType":"addUserInfo","change .image":"getImage"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.model=new Bees.Models.User,this.render()},render:function(){this.$el.prepend(this.template({user:this.model})),this.$el.parsley()},createUser:function(e){e.preventDefault();var s=this,t=this.$el.serializeObject();user=this.model,"beekeeper"==t.userType?user.set("userType","beekeeper"):user.set("userType","farmer"),user.set(t),user.set("costPerHive",+t.costPerHive),user.set("maxDistFree",+t.maxDistFree),user.set("costPerMile",+t.costPerMile),user.set("hivesAvailable",+t.hivesTotal),user.set("hivesTotal",+t.hivesTotal),user.set("zipCode",+t.zipCode),user.set("geoRangeRadius",+t.geoRangeRadius),user.signUp(null,{success:function(e){saveLocation().then(function(){Bees.Session.set("user",e),BeesApp.navigate("/",{trigger:!0}),s.remove()})},error:function(e,s){alert("Error: "+s.code+" "+s.message)}})},addUserInfo:function(e){_.invoke(this.subViews,"dispose");var s=$(e.target).val();this.subViews.push(new Bees.Views.UserTypeFormFields({$container:$(".userType-info"),userType:s}))},getImage:function(e){var s=this,t=$(e.target)[0].files[0],i=new Parse.File(t.name,t);i.save().then(function(){$(".image").attr("disabled",!1),s.model.set("image",i.url())})}}),Bees.Views.UserTypeFormFields=BaseView.extend({initialize:function(e){var s=_.defaults({},e,{$container:e.$container,userType:e.userType});s.$container.html(this.el),this.template="beekeeper"===s.userType?Bees.templates.newUser.beekeeper:Bees.templates.newUser.farmer,this.render()},render:function(){this.$el.prepend(Parse.User.current()?this.template({user:Parse.User.current().toJSON()}):this.template())}})}(),function(){"use strict";Bees.Views.EditAccountView=BaseView.extend({tagName:"form",className:"edit-account",subViews:[],template:Bees.templates.account.edit,events:{submit:"saveUser","change .userType":"addUserInfo","change .image":"getImage"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.render()},render:function(){this.$el.prepend(this.template({user:this.model.toJSON()})),this.$el.parsley(),$("[name=state]").val(this.model.get("state")),$("[name=userType]").val(this.model.get("userType"))},saveUser:function(e){e.preventDefault();var s=this.model,t=this.$el.serializeObject();s.set(t),s.set("costPerHive",+t.costPerHive),s.set("maxDistFree",+t.maxDistFree),s.set("costPerMile",+t.costPerMile),s.set("hivesTotal",+t.hivesTotal),s.set("zipCode",+t.zipCode),s.set("geoRangeRadius",+t.geoRangeRadius),s.save(null,{success:function(){saveLocation()},error:function(e,s){console.log(s)}}),BeesApp.navigate("/",{trigger:!0}),this.dispose()},getImage:function(e){var s=this,t=$(e.target)[0].files[0],i=new Parse.File(t.name,t);i.save().then(function(){$(".image").attr("disabled",!1),s.model.set("image",i.url())})},addUserInfo:function(e){_.invoke(this.subViews,"dispose");var s=$(e.target).val();this.subViews.push(new Bees.Views.UserTypeFormFields({$container:$(".userType-info"),userType:s}))}})}(),function(){"use strict";Bees.Views.Map=BaseView.extend({id:"map",initialize:function(e){var s=_.defaults({},e,{$container:e.$container,radius:e.radius});this.searchRadius=s.radius,s.$container.html(this.el),this.render()},render:function(){var e=this,s=Parse.User.current();this.map=new GMaps({div:"#map",lat:s.get("geoCenter").latitude,lng:s.get("geoCenter").longitude});this.map.addMarker({lat:s.get("geoCenter").latitude,lng:s.get("geoCenter").longitude,icon:"https://maps.google.com/mapfiles/kml/paddle/U.png"}),"beekeeper"==s.get("userType")&&this.drawCircle(s,"#000",this.searchRadius),this.collection.each(function(s){if("beekeeper"===s.get("userType"))var t="https://maps.google.com/mapfiles/kml/paddle/B.png";else var t="https://maps.google.com/mapfiles/kml/paddle/F.png";e.drawCircle(s,"#000",s.get("geoRangeRadius")),e.map.addMarker({lat:s.get("geoCenter").latitude,lng:s.get("geoCenter").longitude,title:s.get("businessName"),icon:t,click:function(){},infoWindow:{content:"<h1>"+s.get("businessName")+'</h1><p><a href="#user/'+s.id+'">Go to profile</a></p>'}})}),this.map.fitZoom()},drawCircle:function(e,s,t){return this.map.drawCircle({lat:e.get("geoCenter").latitude,lng:e.get("geoCenter").longitude,radius:t/62137e-8,fillColor:s,fillOpacity:.1,strokeColor:"#FFF",strokeWeight:1,strokeOpacity:.9,clickable:!0})}})}(),function(){"use strict";Bees.Views.Search=BaseView.extend({subViews:[],tagName:"section",className:"search-container",template:Bees.templates.search.index,initialize:function(e){var s=_.defaults({},e,{$container:e.$container,queryText:e.queryText});s.$container.html(this.el),this.queryText=s.queryText,this.userType=Parse.User.current().get("userType"),this.searchType="beekeeper"==this.userType?"farmer":"beekeeper",this.render()},render:function(){var e=this;if(this.$el.append(this.template()),this.subViews.push(new Bees.Views.NameSearch({$container:$(".search-form-container"),searchType:this.searchType,userType:this.userType})),this.subViews.push(new Bees.Views.DistanceSearch({$container:$(".search-form-container"),searchType:this.searchType,userType:this.userType})),"farmer"===this.userType)queryBeekeepers(0).then(function(s){var s=new Parse.Collection(s);if(s.length>0)e.subViews.push(new Bees.Views.SearchResultsList({$container:$(".search-list-container"),collection:s})),$(".search-params").html(firstCap(e.searchType)+"s whose ranges include you:");else{var t=500;e.searchGeo(t)}e.subViews.push(new Bees.Views.Map({$container:$(".map-container"),collection:s,radius:200}))});else{var s=200;$(".search-params").html(firstCap(this.searchType)+"s within "+s+" miles:"),this.searchGeo(s)}},searchByText:function(){var e=this,s=new Bees.Collections.NameSearch({userType:this.searchType,business:this.queryText.toLowerCase()});s.fetch().then(function(){s.length>0?e.subViews.push(new Bees.Views.SearchResults({collection:s,$container:$(".search-results-container")})):$(".search-results-container").html("<h2>No "+e.searchType+"s found</h2>")})},searchGeo:function(e){var s=this;new Bees.Collections.UserSearchGeo({userType:this.searchType,distance:e}).fetch().then(function(t){if(0===t.length&&5e3>e)s.searchGeo(e+500);else if(t.length>0){if(s.subViews.push(new Bees.Views.SearchResultsList({$container:$(".search-list-container"),collection:t})),s.subViews.push(new Bees.Views.Map({$container:$(".map-container"),collection:t,radius:s.radius})),t.length>1)var i="s";else var i="";"beekeeper"==s.searchType&&$(".search-params").html("<span class='noneFound'>No "+firstCap(s.searchType)+"s found in your area.</span> Found "+t.length+" "+firstCap(s.searchType)+i+" within "+e+" miles:")}else $(".search-list-container").html("<h2>No "+s.searchType+"s found</h2>")})}}),Bees.Views.NameSearch=BaseView.extend({tagName:"form",className:"name-search",template:Bees.templates.search.nameSearch,subViews:[],events:{submit:"search"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container,userType:e.userType,searchType:e.searchType});s.$container.append(this.el),this.model=this.user,this.userType=s.userType,this.searchType=s.searchType,this.render()},render:function(){this.$el.prepend(this.template())},search:function(e){var s=this.$el.serializeObject();if(e.preventDefault(),s.businessName){_.invoke(this.subViews,"dispose");var t=this;new Bees.Collections.NameSearch({userType:this.searchType,business:s.businessName.toLowerCase()}).fetch().then(function(e){e.length>0?(t.subViews.push(new Bees.Views.SearchResults({collection:e,$container:$(".search-list-container")})),t.subViews.push(new Bees.Views.Map({$container:$(".map-container"),collection:e})),$(".search-params").html("Found "+e.length+" "+firstCap(t.searchType)+'s matching "'+s.businessName+'":')):($(".search-list-container").html("<h2>No "+t.searchType+"s found</h2>"),$(".search-params").html("Found "+e.length+" "+firstCap(t.searchType)+'s matching "'+s.businessName+'":'))})}}}),Bees.Views.DistanceSearch=BaseView.extend({tagName:"form",className:"distance-search",template:Bees.templates.search.distance,subViews:[],events:{submit:"search"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container,userType:e.userType});s.$container.append(this.el),this.model=this.user,this.userType=s.userType,this.searchType=s.searchType,this.render()},render:function(){this.$el.prepend(this.template())},search:function(e){e.preventDefault();var s=this.$el.serializeObject();if(s.distance){_.invoke(this.subViews,"dispose");var t=this,i=new Parse.Query(Bees.Models.User);i.equalTo("userType",this.searchType).withinMiles("geoCenter",Parse.User.current().get("geoCenter"),s.distance),i.collection().fetch().then(function(e){e.length>0?(t.subViews.push(new Bees.Views.SearchResults({collection:e,radius:s.distance,$container:$(".search-list-container")})),t.subViews.push(new Bees.Views.Map({$container:$(".map-container"),collection:e,radius:s.distance})),$(".search-params").html("Found "+e.length+" "+firstCap(t.searchType)+"s within "+s.distance+" miles:")):($(".search-list-container").html("<h2>No "+t.searchType+"s found</h2>"),$(".search-params").html("Found "+e.length+" "+firstCap(t.searchType)+"s within "+s.distance+" miles:"))})}}}),Bees.Views.SearchResults=BaseView.extend({className:"search-results",subViews:[],initialize:function(e){var s=_.defaults({},e,{$container:e.$container,radius:e.radius});s.$container.html(this.el),this.radius=s.radius,this.render()},render:function(){_.invoke(this.subViews,"dispose"),this.subViews=[],this.subViews.push(new Bees.Views.SearchResultsList({$container:this.$el,collection:this.collection}))}}),Bees.Views.SearchResultsList=BaseView.extend({tagName:"ul",className:"search-results-users",subViews:[],initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.render()},render:function(){_.invoke(this.subViews,"dispose"),this.collection.each(_.bind(this.renderChildren,this))},renderChildren:function(e){this.subViews.push(new Bees.Views.SearchResultsListItem({$container:this.$el,model:e}))}}),Bees.Views.SearchResultsListItem=BaseView.extend({tagName:"li",className:"search-results-user",template:Bees.templates.search.resultItem,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render()},render:function(){_.invoke(this.subViews,"dispose"),this.$el.html(this.template({user:this.model.toJSON()}))}})}(),function(){"use strict";Bees.Views.User=BaseView.extend({className:"user",subViews:[],tagName:"section",events:{"click .newMessage":"newMessage"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),$(".main-menu a").removeClass("selected-nav"),this.render()},render:function(){_.invoke(this.subViews,"dispose");if("beekeeper"===this.model.get("userType")){this.template=Bees.templates.user.beekeeperIndex;var e=Math.ceil(this.model.get("geoCenter").milesTo(Parse.User.current().get("geoCenter"))),s=(this.model.get("costPerMile")/100).toFixed(2);this.$el.append(this.template({user:this.model.toJSON(),distance:e,transportCost:s})),this.subViews.push(new Bees.Views.RequestNew({$container:$(".new-request"),model:this.model})),this.subViews.push(new Bees.Views.UserReviews({$container:$(".reviews"),model:this.model}))}else this.template=Bees.templates.user.farmerIndex,this.$el.append(this.template({user:this.model.toJSON()})),this.subViews.push(new Bees.Views.UserReviews({$container:$(".reviews"),model:this.model}))},newMessage:function(e){e.preventDefault(),new Bees.Views.NewMessage({$container:$(".newMessage-container"),recepient:this.model,method:"fill",msgType:"new"})}}),Bees.Views.RequestNew=BaseView.extend({template:Bees.templates.user.request,events:{"click .calculate":"calculate","click .getBees":"getBees"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.$container=s.container,this.request=new Bees.Models.Request,this.render(),this.listenTo(this.request,"change",this.render)},render:function(){this.$el.html(this.template({user:this.model.toJSON(),request:this.request.toJSON(),distance:this.distance}))},calculate:function(e){e.preventDefault();var s=+$("[name=numHives]").val();s<=this.model.get("hivesAvailable")&&s>0?this.request.set(calculateCost(s,this.model)):alert(0>=s?"Please enter a request of 1 or more hives.":"You've selected more hives than the number available in the beekeeper's inventory.")},getBees:function(){var e=this,s=Parse.User.current(),t=this.model,i=$("[name=startDate]").val(),n=$("[name=endDate]").val(),r=$("[name=message]").val(),a=new Bees.Models.Request;a.set("beekeeper",t),a.set("farmer",s),a.set("startDate",i),a.set("endDate",n),a.set("message",r),a.set(this.request.toJSON()),a.save().then(function(){var s={message:"Go to the website and accept the request",subject:"New Request for bees",from:"jgoley@gmail.com",to:"jgoley.etc@gmail.com"};sendMail(s),e.dispose(),$(".new-request").append("<h2 class='submitted'>Request submitted!</h1>")})}})}(),function(){"use strict";Bees.Views.UserReviews=BaseView.extend({className:"user-reviews",subViews:[],initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render()},render:function(){_.invoke(this.subViews,"dispose");var e=this;new Bees.Collections.UserReviews({user:this.model}).getAll().then(function(s){s=new Parse.Collection(s);var t=s.find(function(e){return e.get("reviewer").id===Parse.User.current().id});t||e.subViews.push(new Bees.Views.UserReviewsNew({collection:s,model:e.model,$container:e.$el})),e.subViews.push(s.length>0?new Bees.Views.UserReviewsList({$container:e.$el,model:e.model,collection:s}):new Bees.Views.UserReviewsList({$container:e.$el,model:e.model,collection:s}))})}}),Bees.Views.UserReviewsPage=BaseView.extend({className:"reviews-container",tagName:"section",subViews:[],initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.render()},render:function(){this.$el.html("<div class='reviews'><h1 class='main-title'>Reviews</h1></div>"),_.invoke(this.subViews,"dispose"),this.collection.length>0?this.subViews.push(new Bees.Views.UserReviewsList({$container:$(".reviews"),collection:this.collection})):$(".reviews").append("<div><h3>You currently do not have any reviews.</h3></div>")}}),Bees.Views.UserReviewsList=BaseView.extend({tagName:"ul",className:"review-list",subViews:[],initialize:function(e){_.invoke(this.subViews,"dispose");var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render(),this.listenTo(this.collection,"add",this.render)},render:function(){_.invoke(this.subViews,"dispose"),this.$el.empty(),this.collection&&this.collection.each(_.bind(this.renderChildren,this))},renderChildren:function(e){this.subViews.push(new Bees.Views.UserReviewsListItem({model:e,$container:this.$el}))}}),Bees.Views.UserReviewsListItem=BaseView.extend({tagName:"li",className:"review-list-item",template:Bees.templates.reviews.listItem,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.prepend(this.el),this.render()},render:function(){var e=this,s=moment(this.model.createdAt).format("MMM D, YYYY | h:mm a"),t=new Parse.Query(Bees.Models.User);t.get(this.model.get("reviewer").id).then(function(t){e.$el.append(e.template({review:e.model.toJSON(),reviewer:t.toJSON(),createdAt:s}))})}}),Bees.Views.UserReviewsNew=BaseView.extend({className:"new-review",subViews:[],events:{"click .add-review":"addReview"},template:Bees.templates.reviews.new,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render()},render:function(){_.invoke(this.subViews,"dispose"),this.$el.append(this.template())},addReview:function(){this.subViews.push(new Bees.Views.UserReviewsAdd({$container:this.$el,model:this.model,collection:this.collection}))}}),Bees.Views.UserReviewsAdd=BaseView.extend({tagName:"form",className:"review",events:{submit:"submitReview","click .cancel-review":"cancel"},template:Bees.templates.reviews.add,initialize:function(e){_.invoke(this.subViews,"dispose");var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.$container=s.$container,this.render()},render:function(){this.$el.append(this.template())},submitReview:function(e){e.preventDefault();var s=this.$el.serializeObject(),t=new Bees.Models.Review;t.set("reviewer",Parse.User.current()),t.set("reviewee",this.model),t.save(s),this.collection.add(t),this.$container.append('<h2 class="submitted">Review submitted</h2>'),this.dispose()},cancel:function(){this.dispose(),new Bees.Views.UserReviewsNew({collection:this.collection,model:this.model,$container:$(".user-reviews")})}})}(),function(){"use strict";Bees.Views.BeekeeperIndex=BaseView.extend({className:"landing",subViews:[],currentDate:moment().format("YYYY-MM-DD"),currentDatePlus:moment().add(14,"days").format("YYYY-MM-DD"),template:Bees.templates.userLanding,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.render()},render:function(){var e=this,s=this.collection;this.$el.html(this.template(Parse.User.current().toJSON()));var t=new Parse.Collection(s.filter(function(s){return s.get("startDate")<=e.currentDate&&s.get("endDate")>=e.currentDate})),i=new Parse.Collection(s.filter(function(e){return!e.get("accepted")})),n=new Parse.Collection(s.filter(function(s){return s.get("startDate")>=e.currentDate&&s.get("startDate")<=e.currentDatePlus&&s.get("accepted")
}));n.length>0&&this.subViews.push(new Bees.Views.BeekeeperUpcomingRequestsList({$container:$(".active-request-info"),collection:n})),t.length>0?this.subViews.push(new Bees.Views.BeekeeperHivesOut({$container:$(".active-request-info"),collection:t})):$(".hives-out").append("<p>Currently you have no pending requests.</p>"),0===t.length&&0===n.length&&$(".active-request-container").remove(),i.length>0?this.subViews.push(new Bees.Views.RequestList({$container:$(".requests"),collection:i})):($(".requests").append("<p>You currently do not have any pending requests.</p>"),$(".request-list-container .button").remove()),new Bees.Collections.UserReviews({user:Parse.User.current(),limit:5}).getAll().then(function(s){s=new Parse.Collection(s),s.length>0?e.subViews.push(new Bees.Views.UserReviewsList({$container:$(".reviews"),collection:s})):$(".reviews").append("<p>You currently do not have any reviews.</p>")}),new Bees.Collections.UserSearchGeo({userType:"farmer",distance:200,limit:5}).fetch().then(function(s){e.subViews.push(new Bees.Views.UserShortList({$container:$(".near-users"),collection:s,type:"Farmers"}))})}}),Bees.Views.BeekeeperIndexInfo=BaseView.extend({className:"beekeeper-details",template:Bees.templates.beekeeperIndex.details,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render()},render:function(){this.$el.append(this.template(Parse.User.current().toJSON()))}}),Bees.Views.BeekeeperHivesOut=BaseView.extend({subViews:[],tagName:"ul",className:"hives-out",template:Bees.templates.beekeeperIndex.hivesOut,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render()},render:function(){_.invoke(this.subViews,"dispose");this.$el.append('<h1 class="main-title">Hives currently out:</h1>'),this.collection.each(_.bind(this.renderChildren,this))},renderChildren:function(e){this.subViews.push(new Bees.Views.BeekeeperHivesOutListItem({$container:this.$el,model:e}))}}),Bees.Views.BeekeeperHivesOutListItem=BaseView.extend({tagName:"li",className:"hives-out-request",template:Bees.templates.beekeeperIndex.hivesOutListItem,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render()},render:function(){var e,s=this,t=this.model,i={createdAt:moment(t.createdAt).format("MMM D, YYYY | h:mm a"),startDate:moment(t.get("startDate")).format("MMM D, YYYY"),endDate:moment(t.get("endDate")).format("MMM D, YYYY"),startDateFromNow:moment(moment(t.get("startDate")).add(1,"day")).fromNow(),endDateFromNow:moment(moment(t.get("endDate")).add(1,"day")).fromNow()};e="beekeeper"===Parse.User.current().get("userType")?"farmer":"beekeeper";var n=new Parse.Query(Bees.Models.User);n.get(this.model.get(e).id).then(function(e){s.$el.append(s.template({request:t.toJSON(),user:e.toJSON(),formattedDates:i}))})}})}(),function(){"use strict";Bees.Views.FarmerIndex=BaseView.extend({subViews:[],className:"landing",template:Bees.templates.userLanding,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.render()},render:function(){var e=this,s=this.collection;this.$el.html(this.template(Parse.User.current().toJSON()));var t=new Parse.Collection(s.filter(function(e){return!e.get("accepted")}));t.length>0?this.subViews.push(new Bees.Views.RequestList({$container:$(".requests"),collection:t})):($(".requests").append("<p>You currently do not have any pending requests.</p>"),$(".requests-list-container").find(".button").remove()),new Bees.Collections.UserReviews({user:Parse.User.current(),limit:5}).getAll().then(function(s){s=new Parse.Collection(s),s.length>0?e.subViews.push(new Bees.Views.UserReviewsList({$container:$(".reviews"),collection:s})):($(".reviews").append("<p>You currently do not have any reviews.</p>"),$(".reviews-list-container").find(".button").remove())}),queryBeekeepers(0).then(function(s){s=new Parse.Collection(s),s.length>0?e.subViews.push(new Bees.Views.UserShortList({$container:$(".near-users"),collection:s,type:"Beekeepers"})):e.searchGeo(500)})},searchGeo:function(e){var s=this;new Bees.Collections.UserSearchGeo({userType:"beekeeper",distance:e,limit:5}).fetch().then(function(t){0===t.length?s.searchGeo(e+500):s.subViews.push(new Bees.Views.UserShortList({$container:$(".near-users"),collection:t,type:"Beekeepers"}))})}})}(),function(){"use strict";Bees.Views.Requests=BaseView.extend({className:"request-container",tagName:"section",subViews:[],template:Bees.templates.requests.base,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.render()},render:function(){this.$el.html(this.template());var e=this.collection;0===this.collection.length&&$(".requests").append("<h3>Currently, you have no requests</h3>");var s=new Parse.Collection(e.filter(function(e){return e.get("accepted")===!1}));if("beekeeper"===Parse.User.current().get("userType"))var t="archivedBeekeeper";else var t="archivedFarmer";var i=new Parse.Collection(e.filter(function(e){return e.get("accepted")&&!e.get(t)})),n=new Parse.Collection(e.filter(function(e){return e.get(t)}));s.length>0&&this.subViews.push(new Bees.Views.RequestList({$container:$(".requests"),collection:s,info:{title:"Pending Requests","class":"notAccepted"}})),i.length>0&&this.subViews.push(new Bees.Views.RequestList({$container:$(".requests"),collection:i,info:{title:"Accepted Requests","class":"accepted"}})),n.length>0&&0===i.length&&0===s.length?this.subViews.push(new Bees.Views.RequestList({$container:$(".requests"),collection:n,info:{title:"Archived","class":"archived"}})):n.length>0&&$(".requests").append('<a href="#/requests/archived" class="button archived">View Archived Requests</a>')}}),Bees.Views.RequestList=BaseView.extend({tagName:"ul",subViews:[],className:"request-list",initialize:function(e){var s=_.defaults({},e,{$container:e.$container,info:e.info});this.info=s.info,s.$container.append(this.el),this.render()},render:function(){this.info&&this.$el.append('<h1 class="main-title">'+this.info.title+"</h1>"),0===this.collection.length&&this.$el.append(),this.collection.each(_.bind(this.renderChildren,this))},renderChildren:function(e){this.subViews.push(new Bees.Views.RequestListItem({model:e,$container:this.$el}))}}),Bees.Views.RequestListItem=BaseView.extend({tagName:"li",className:"request",events:{"click .accept":"acceptRequest","click .archive":"archiveRequest","click .cancel":"cancelRequest","click .delete":"deleteRequest","click .more-info":"moreInfo","click .edit-request":"editRequest"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.userType=Parse.User.current().get("userType"),this.template="beekeeper"===this.userType?Bees.templates.requests.listItemBeekeeper:Bees.templates.requests.listItemFarmer,this.render(),this.listenTo(this.model,"change:accepted",this.render),this.listenTo(this.model,"change:archivedBeekeeper",this.render),this.listenTo(this.model,"change:archivedFarmer",this.render),this.listenTo(this.model,"change:delete",this.render)},render:function(){_.invoke(this.subViews,"dispose");var e=this,s=this.model,t={createdAt:moment(s.createdAt).format("MMM D, YYYY | h:mm a"),startDate:moment(s.get("startDate")).format("MMM D, YYYY"),endDate:moment(s.get("endDate")).format("MMM D, YYYY"),archivedBeekeeperDate:moment(s.get("archivedBeekeeperDate")).format("MMM D, YYYY")};if("beekeeper"===this.userType)var i="farmer";else var i="beekeeper";var n=new Parse.Query(Bees.Models.User);n.get(s.get(i).id).then(function(i){e.$el.html(e.template({request:s.toJSON(),user:i.toJSON(),formattedDates:t}))})},acceptRequest:function(){var e=Parse.User.current(),s=this.model,t=e.get("hivesAvailable");t>s.get("numHives")?(s.set({accepted:!0,acceptedDate:new Date}),s.save(),e.set("hivesAvailable",e.get("hivesAvailable")-s.get("numHives")),e.save(),s.get("farmer").fetch().done(function(){var e={subject:"Request for Bees Accepted!",message:"Your request for bees has been accepted. Details:"+Parse.User.current().get("username")+" "+s.id+" "+s.get("startDate")+" "+s.get("endDate"),from:"jgoley.etc@gmail.com",to:"jgoley@gmail.com"};sendMail(e)})):alert("You don't have enough hives in your inventory to fulfill request")},archiveRequest:function(){var e=Parse.User.current(),s=this.model;"beekeeper"===e.get("userType")?(e.set("hivesAvailable",e.get("hivesAvailable")+s.get("numHives")),e.save(),s.set("archivedBeekeeper",!0),s.set("archivedBeekeeperDate",new Date)):s.set("archivedFarmer",!0),s.save()},cancelRequest:function(){this.model.set("canceled",!0);var e={subject:"Request for Bees Canceled",message:Parse.User.current().get("username")+" canceled their request for bees",from:"jgoley.etc@gmail.com",to:"jgoley@gmail.com"};sendMail(e)},deleteRequest:function(){var e=confirm("Are you sure you want to delete the request?");e&&(this.model.destroy(),this.dispose())},moreInfo:function(){this.$el.find("ul").toggleClass("hidden"),this.$el.toggleClass("selected")},editRequest:function(){BeesApp.navigate("request/"+this.model.id+"/edit",{trigger:!0})}}),Bees.Views.BeekeeperUpcomingRequestsList=BaseView.extend({tagName:"ul",subViews:[],className:"upcoming-requests",initialize:function(e){var s=_.defaults({},e,{$container:e.$container,info:e.info});this.info=s.info,s.$container.append(this.el),this.render()},render:function(){_.invoke(this.subViews,"dispose"),this.$el.append('<h1 class="main-title">Upcoming requests:</h1>'),this.info&&this.$el.append('<h1 class="main-title">'+this.info.title+"</h1>"),0===this.collection.length&&this.$el.append(),this.collection.each(_.bind(this.renderChildren,this))},renderChildren:function(e){this.subViews.push(new Bees.Views.BeekeeperUpcomingRequestsListItem({model:e,$container:this.$el}))}}),Bees.Views.BeekeeperUpcomingRequestsListItem=BaseView.extend({tagName:"li",className:"upcoming-request",template:Bees.templates.beekeeperIndex.upcoming,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render()},render:function(){_.invoke(this.subViews,"dispose");var e=this.model,s={createdAt:moment(e.createdAt).format("MMM D, YYYY | h:mm a"),startDate:moment(e.get("startDate")).format("MMM D, YYYY"),endDate:moment(e.get("endDate")).format("MMM D, YYYY"),startDateFromNow:moment(moment(e.get("startDate")).add(1,"day")).fromNow(),endDateFromNow:moment(moment(e.get("endDate")).add(1,"day")).fromNow()};if(this.userType=Parse.User.current().get("userType"),"beekeeper"===this.userType)var t="farmer";else var t="beekeeper";var i=this,n=new Parse.Query(Bees.Models.User);n.get(e.get(t).id).then(function(t){i.$el.html(i.template({request:e.toJSON(),user:t.toJSON(),formattedDates:s}))})}})}(),function(){"use strict";Bees.Views.Request=BaseView.extend({className:"request-container",tagName:"section",template:Bees.templates.requests.solo,events:{"click .edit-request":"editRequest"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.render()},render:function(){var e=this.model;if(e.get("archivedBeekeeper")===!0||e.get("archivedFarmer")===!0)var s=!0;if("beekeeper"===Parse.User.current().get("userType"))var t="farmer";else var t="beekeeper";var i={createdAt:moment(e.createdAt).format("MMM D, YYYY | h:mm a"),startDate:moment(e.get("startDate")).format("MMM D, YYYY"),endDate:moment(e.get("endDate")).format("MMM D, YYYY"),startDateFromNow:moment(moment(e.get("startDate")).add(1,"day")).fromNow(),endDateFromNow:moment(moment(e.get("endDate")).add(1,"day")).fromNow()},n=this,r=new Parse.Query(Bees.Models.User);r.get(e.get(t).id).then(function(t){n.$el.append(n.template({request:e.toJSON(),archived:s,curUser:Parse.User.current().toJSON(),otherUser:t.toJSON(),formattedDates:i}))})},editRequest:function(){BeesApp.navigate("request/"+this.model.id+"/edit",{trigger:!0})}}),Bees.Views.RequestEdit=BaseView.extend({className:"request-container",tagName:"section",template:Bees.templates.requests.soloEdit,events:{"click .edit-request":"editRequest","click .cancel-edit":"cancel","click .accept":"acceptRequest"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container,beekeeper:e.beekeeper});this.beekeeper=s.beekeeper,s.$container.html(this.el),this.render()},render:function(){this.$el.append(this.template(this.model.toJSON()))},acceptRequest:function(){var e=Parse.User.current(),s=this.model,t=e.get("hivesAvailable");t>s.get("numHives")?this.model.set("accepted",!0).save():alert("You don't have enough hives in your inventory to fulfill request")},editRequest:function(){var e=this,s=this.model,t=Parse.User.current(),i=(this.beekeeper,$("[name=startDate]").val()),n=$("[name=endDate]").val(),r=$("[name=numHives]").val(),t=new Parse.Query(Bees.Models.User);t.get(this.model.get("beekeeper").id).then(function(t){r<=t.get("hivesAvailable")&&r>0?(s.set(calculateCost(r,t)),s.set("startDate",i),s.set("endDate",n)):alert(0>=r?"Please enter a request of 1 or more hives":"You've selected more hives than the number available in the beekeeper's inventory"),s.save();var a={message:"Request "+s.id+"has been updated. The requested hive number of hives is "+s.get("numHives"),subject:"Pollinate Request has been edited",from:"jgoley.etc@gmail.com",to:"jgoley@gmail.com"};sendMail(a),BeesApp.navigate("request/"+e.model.id,{trigger:!0})})},cancel:function(){BeesApp.navigate("request/"+this.model.id,{trigger:!0})}})}(),function(){"use strict";Bees.Views.UserShortList=BaseView.extend({subViews:[],tagName:"ul",className:"short-list",initialize:function(e){var s=_.defaults({},e,{$container:e.$container,type:e.type});s.$container.prepend(this.el),this.type=s.type,this.render()},render:function(){this.$el.append('<h1 class="main-title">'+this.type+" near you:</h1>"),this.collection.each(_.bind(this.renderChildren,this))},renderChildren:function(e){this.subViews.push(new Bees.Views.UserShortListItem({$container:this.$el,model:e}))}}),Bees.Views.UserShortListItem=BaseView.extend({tagName:"li",className:"short-list-item",template:Bees.templates.shortList,initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.append(this.el),this.render()},render:function(){this.$el.append(this.template({user:this.model.toJSON()}))}})}(),function(){"use strict";Bees.Views.Messages=BaseView.extend({className:"messages-container",subViews:[],tagName:"section",template:Bees.templates.messages.index,events:{"click .newMessage":"newMessage"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container});s.$container.html(this.el),this.render()},render:function(){_.invoke(this.subViews,"dispose"),this.$el.html(this.template());var e=this;new Bees.Collections.UserMessages({user:Parse.User.current()}).getSent().then(function(s){e.populateMessages(s,"sent")}),new Bees.Collections.UserMessages({user:Parse.User.current()}).getReceived().then(function(s){e.populateMessages(s,"received")})},populateMessages:function(e,s){var e=new Parse.Collection(e);e.length>0?(this[s]=e,this.subViews.push(new Bees.Views.MessagesList({$container:$("."+s+"-messages"),collection:e,type:s,parentView:this}))):$("."+s+"-messages").append("<h3>Currently no "+s+" messages.</h3>")},newMessage:function(){}}),Bees.Views.MessagesList=BaseView.extend({tagName:"ul",subViews:[],className:"message-list",initialize:function(e){var s=_.defaults({},e,{$container:e.$container,type:e.type,parentView:e.parentView});s.$container.append(this.el),this.sentMsgs=s.parentView.sent,this.recievedMsgs=s.parentView.recieved,this.type=s.type,this.render()},render:function(){this.$el.empty(),this.collection.each(_.bind(this.renderChildren,this))},renderChildren:function(e){this.subViews.push("received"===this.type?new Bees.Views.MessagesListItem({model:e,$container:this.$el,type:this.type,collection:this.collection,sentMsgs:this.sentMsgs}):new Bees.Views.MessagesListItem({model:e,$container:this.$el,type:this.type,collection:this.collection}))}}),Bees.Views.MessagesListItem=BaseView.extend({tagName:"li",className:"message",subViews:[],template:Bees.templates.messages.message,events:{"click .reply":"reply"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container,type:e.type,sentMsgs:e.sentMsgs});s.$container.append(this.el),this.sentMsgs=s.sentMsgs,this.type=s.type,this.render()},render:function(){_.invoke(this.subViews,"dispose");var e=moment(this.model.createdAt).fromNow();this.$el.append(this.template({message:this.model.toJSON(),type:this.type,sentDate:e}))},reply:function(e){e.preventDefault(),this.$el.find(".reply").remove(),this.subViews.push(new Bees.Views.NewMessage({$container:this.$el,model:this.model,method:"append",msgType:"reply",collection:this.collection,sentMsgs:this.sentMsgs}))}}),Bees.Views.NewMessage=BaseView.extend({template:Bees.templates.user.newMessage,tagName:"form",className:"new-message",events:{submit:"sendMessage",cancel:"cancel"},initialize:function(e){var s=_.defaults({},e,{$container:e.$container,recepient:e.recepient,method:e.method,msgType:e.msgType,sentMsgs:e.sentMsgs});this.sentMsgs=s.sentMsgs,this.msgType=s.msgType,this.recepient=s.recepient,this.sender=Parse.User.current(),this.$container=s.$container,this.message=new Bees.Models.Message,"fill"!==s.method&&s.method?s.$container.append(this.el):s.$container.html(this.el),this.render()},render:function(){this.$el.html(this.template())},sendMessage:function(e){"new"===this.msgType?this.sendNew(e):this.sendReply(e)},sendNew:function(e){e.preventDefault();var s=this,t=this.message,i=$("[name=message]").val();t.set("message",i),t.set("recipient",this.recepient),t.set("recipientName",this.recepient.get("username")),t.set("sender",this.sender),t.set("senderName",this.sender.get("username")),t.save({success:function(){var e={message:"<p>You received a message on Pollinate!</p><p>"+s.sender.get("username")+" says:</p><p>"+i+'</p><a href="#">Goto Pollinate to respond</a>',subject:"New Message on Pollinate",from:"jgoley.etc@gmail.com",to:"jgoley@gmail.com"};sendMail(e)},error:function(e,s){console.error(s)}}),this.dispose(),$(".newMessage-container").append("<h2 class='submitted'>Message sent!</h1>"),this.sentMsgs&&this.sentMsgs.add(t)},sendReply:function(e){e.preventDefault();var s=this,t=this.model,i=this.message,n=$("[name=message]").val();n.length>5?(i.set("message",n),i.set("recipient",t.get("sender")),i.set("recipientName",t.get("senderName")),i.set("sender",t.get("recipient")),i.set("senderName",t.get("recipientName")),i.set("msgType","reply"),i.save({success:function(){var e={message:"<p>You received a message on Pollinate!</p><p>"+s.sender.get("username")+" says:</p><p>"+n+'</p><a href="#">Goto Pollinate to respond</a>',subject:"New Message on Pollinate",from:"jgoley.etc@gmail.com",to:"jgoley@gmail.com"};sendMail(e),t.set("replied",!0),t.save()},error:function(e,s){console.error(s)}}),this.dispose(),s.$container.append('<h2 class="submitted">Reply sent</h2>'),s.collection.add(i)):alert("Your message is too short."),this.sentMsgs.add(i),this.model.set("replied",!0),this.model.save()},cancel:function(){this.dispose()}})}();